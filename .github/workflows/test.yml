name: test-qrhl-tool
on: [push]
env:
  ISA_VER: 2021-1-RC3
jobs:
    test:
      strategy:
        matrix:
          os: [windows] # TODO linux
      runs-on: [self-hosted, "${{matrix.os}}"]
      steps:
        - name: Checkout repository
          uses: actions/checkout@v2
          with:
            submodules: true

        - name: Running tests (Linux)
          if: matrix.os == 'linux'
          run: |
            echo isabelle-home = /opt/Isabelle$ISA_VER >qrhl-tool.conf
            sbt 'testOnly -- -h target/test-reports-html'

        - name: Install OpenSSH
          if: matrix.os == 'windows'
          run: |
            Get-CimInstance -Class Win32_OperatingSystem | Get-Member -MemberType Property
            Get-CIMInstance Win32_OperatingSystem | Select FreePhysicalMemory,TotalVisibleMemory,FreeVirtualMemory,TotalVirtualMemorySize,TotalVisibleMemorySize

        - name: Building Complex_Bounded_Operators (Windows)
          if: matrix.os == 'windows'
          # We run a build of Complex_Bounded_Operators first because we need to pass the timeout_scale=4 option
          # otherwise the build fails on my small Windows computer
          run: |
            c:\Isabelle${{env.ISA_VER}}\contrib\cygwin\bin\bash --login -c "/cygdrive/c/Isabelle${{env.ISA_VER}}/bin/isabelle build -b -o timeout_scale=4 -v Complex_Bounded_Operators"

        - name: Running tests (Windows)
          if: matrix.os == 'windows'
          run: |
            Set-Content -Path qrhl-tool.conf -Value 'isabelle-home = c:\Isabelle${{env.ISA_VER}}'
            sbt 'testOnly -- -h target/test-reports-html'
            
        - name: Upload test results
          uses: actions/upload-artifact@v2
          if: always()
          with:
            name: test-reports-html
            path: target/test-reports-html
